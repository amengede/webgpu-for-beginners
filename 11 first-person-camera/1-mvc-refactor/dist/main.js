(()=>{"use strict";const e="struct TransformData {\r\n    model: mat4x4<f32>,\r\n    view: mat4x4<f32>,\r\n    projection: mat4x4<f32>,\r\n};\r\n@binding(0) @group(0) var<uniform> transformUBO: TransformData;\r\n@binding(1) @group(0) var myTexture: texture_2d<f32>;\r\n@binding(2) @group(0) var mySampler: sampler;\r\n\r\nstruct Fragment {\r\n    @builtin(position) Position : vec4<f32>,\r\n    @location(0) TexCoord : vec2<f32>\r\n};\r\n\r\n@vertex\r\nfn vs_main(@location(0) vertexPostion: vec3<f32>, @location(1) vertexTexCoord: vec2<f32>) -> Fragment {\r\n\r\n    var output : Fragment;\r\n    output.Position = transformUBO.projection * transformUBO.view * transformUBO.model * vec4<f32>(vertexPostion, 1.0);\r\n    output.TexCoord = vertexTexCoord;\r\n\r\n    return output;\r\n}\r\n\r\n@fragment\r\nfn fs_main(@location(0) TexCoord : vec2<f32>) -> @location(0) vec4<f32> {\r\n    return textureSample(myTexture, mySampler, TexCoord);\r\n}";class t{constructor(e){const t=new Float32Array([0,0,.5,.5,0,0,-.5,-.5,0,1,0,.5,-.5,1,1]),i=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,r={size:t.byteLength,usage:i,mappedAtCreation:!0};this.buffer=e.createBuffer(r),new Float32Array(this.buffer.getMappedRange()).set(t),this.buffer.unmap(),this.bufferLayout={arrayStride:20,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x2",offset:12}]}}}var i=1e-6,r="undefined"!=typeof Float32Array?Float32Array:Array;function n(){var e=new r(16);return r!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var s=function(e,t,i,r){return new(i||(i=Promise))((function(n,s){function a(e){try{u(r.next(e))}catch(e){s(e)}}function o(e){try{u(r.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}u((r=r.apply(e,t||[])).next())}))};class a{initialize(e,t){return s(this,void 0,void 0,(function*(){const i=yield fetch(t),r=yield i.blob(),n=yield createImageBitmap(r);yield this.loadImageBitmap(e,n),this.view=this.texture.createView({format:"rgba8unorm",dimension:"2d",aspect:"all",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1}),this.sampler=e.createSampler({addressModeU:"repeat",addressModeV:"repeat",magFilter:"linear",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1})}))}loadImageBitmap(e,t){return s(this,void 0,void 0,(function*(){const i={size:{width:t.width,height:t.height},format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT};this.texture=e.createTexture(i),e.queue.copyExternalImageToTexture({source:t},{texture:this.texture},i.size)}))}}var o=function(e,t,i,r){return new(i||(i=Promise))((function(n,s){function a(e){try{u(r.next(e))}catch(e){s(e)}}function o(e){try{u(r.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}u((r=r.apply(e,t||[])).next())}))};class u{constructor(e){this.canvas=e}Initialize(){return o(this,void 0,void 0,(function*(){yield this.setupDevice(),yield this.createAssets(),yield this.makePipeline()}))}setupDevice(){var e,t;return o(this,void 0,void 0,(function*(){this.adapter=yield null===(e=navigator.gpu)||void 0===e?void 0:e.requestAdapter(),this.device=yield null===(t=this.adapter)||void 0===t?void 0:t.requestDevice(),this.context=this.canvas.getContext("webgpu"),this.format="bgra8unorm",this.context.configure({device:this.device,format:this.format,alphaMode:"opaque"})}))}makePipeline(){return o(this,void 0,void 0,(function*(){this.uniformBuffer=this.device.createBuffer({size:192,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const t=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]});this.bindGroup=this.device.createBindGroup({layout:t,entries:[{binding:0,resource:{buffer:this.uniformBuffer}},{binding:1,resource:this.material.view},{binding:2,resource:this.material.sampler}]});const i=this.device.createPipelineLayout({bindGroupLayouts:[t]});this.pipeline=this.device.createRenderPipeline({vertex:{module:this.device.createShaderModule({code:e}),entryPoint:"vs_main",buffers:[this.triangleMesh.bufferLayout]},fragment:{module:this.device.createShaderModule({code:e}),entryPoint:"fs_main",targets:[{format:this.format}]},primitive:{topology:"triangle-list"},layout:i})}))}createAssets(){return o(this,void 0,void 0,(function*(){this.triangleMesh=new t(this.device),this.material=new a,yield this.material.initialize(this.device,"dist/img/chat.jpg")}))}render(e,t){return o(this,void 0,void 0,(function*(){const i=n();var r,s,a,o,u,h,c;r=i,s=Math.PI/4,a=800/600,o=.1,u=10,c=1/Math.tan(s/2),r[0]=c/a,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=c,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,null!=u&&u!==1/0?(h=1/(o-u),r[10]=(u+o)*h,r[14]=2*u*o*h):(r[10]=-1,r[14]=-2*o);const d=e.get_view();this.device.queue.writeBuffer(this.uniformBuffer,64,d),this.device.queue.writeBuffer(this.uniformBuffer,128,i);const f=this.device.createCommandEncoder(),l=this.context.getCurrentTexture().createView(),v=f.beginRenderPass({colorAttachments:[{view:l,clearValue:{r:.5,g:0,b:.25,a:1},loadOp:"clear",storeOp:"store"}]});v.setPipeline(this.pipeline),v.setVertexBuffer(0,this.triangleMesh.buffer),t.forEach((e=>{const t=e.get_model();this.device.queue.writeBuffer(this.uniformBuffer,0,t),v.setBindGroup(0,this.bindGroup),v.draw(3,1,0,0)})),v.end(),this.device.queue.submit([f.finish()])}))}}function h(){var e=new r(3);return r!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function c(e,t,i){var r=t[0],n=t[1],s=t[2],a=i[0],o=i[1],u=i[2];return e[0]=n*u-s*o,e[1]=s*a-r*u,e[2]=r*o-n*a,e}function d(e){return e*Math.PI/180}h();class f{constructor(e,t){this.position=e,this.eulers=h(),this.eulers[2]=t}update(){var e,t,i,r,s,a,o,u,h,c,f,l,v,m,p,g,y,x;this.eulers[2]+=1,this.eulers[2]%=360,this.model=n(),e=this.model,t=this.model,g=(i=this.position)[0],y=i[1],x=i[2],t===e?(e[12]=t[0]*g+t[4]*y+t[8]*x+t[12],e[13]=t[1]*g+t[5]*y+t[9]*x+t[13],e[14]=t[2]*g+t[6]*y+t[10]*x+t[14],e[15]=t[3]*g+t[7]*y+t[11]*x+t[15]):(r=t[0],s=t[1],a=t[2],o=t[3],u=t[4],h=t[5],c=t[6],f=t[7],l=t[8],v=t[9],m=t[10],p=t[11],e[0]=r,e[1]=s,e[2]=a,e[3]=o,e[4]=u,e[5]=h,e[6]=c,e[7]=f,e[8]=l,e[9]=v,e[10]=m,e[11]=p,e[12]=r*g+u*y+l*x+t[12],e[13]=s*g+h*y+v*x+t[13],e[14]=a*g+c*y+m*x+t[14],e[15]=o*g+f*y+p*x+t[15]),function(e,t,i){var r=Math.sin(i),n=Math.cos(i),s=t[0],a=t[1],o=t[2],u=t[3],h=t[4],c=t[5],d=t[6],f=t[7];t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=s*n+h*r,e[1]=a*n+c*r,e[2]=o*n+d*r,e[3]=u*n+f*r,e[4]=h*n-s*r,e[5]=c*n-a*r,e[6]=d*n-o*r,e[7]=f*n-u*r}(this.model,this.model,d(this.eulers[2]))}get_model(){return this.model}}class l{constructor(e,t,i){this.position=e,this.eulers=[0,i,t],this.forwards=h(),this.right=h(),this.up=h()}update(){this.forwards=[Math.cos(d(this.eulers[2]))*Math.cos(d(this.eulers[1])),Math.sin(d(this.eulers[2]))*Math.cos(d(this.eulers[1])),Math.sin(d(this.eulers[1]))],c(this.right,this.forwards,[0,0,1]),c(this.up,this.right,this.forwards);var e,t,r,s=h();e=s,t=this.position,r=this.forwards,e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],this.view=n(),function(e,t,r,n){var s,a,o,u,h,c,d,f,l,v,m=t[0],p=t[1],g=t[2],y=n[0],x=n[1],w=n[2],b=r[0],M=r[1],P=r[2];Math.abs(m-b)<i&&Math.abs(p-M)<i&&Math.abs(g-P)<i?function(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(e):(d=m-b,f=p-M,l=g-P,s=x*(l*=v=1/Math.hypot(d,f,l))-w*(f*=v),a=w*(d*=v)-y*l,o=y*f-x*d,(v=Math.hypot(s,a,o))?(s*=v=1/v,a*=v,o*=v):(s=0,a=0,o=0),u=f*o-l*a,h=l*s-d*o,c=d*a-f*s,(v=Math.hypot(u,h,c))?(u*=v=1/v,h*=v,c*=v):(u=0,h=0,c=0),e[0]=s,e[1]=u,e[2]=d,e[3]=0,e[4]=a,e[5]=h,e[6]=f,e[7]=0,e[8]=o,e[9]=c,e[10]=l,e[11]=0,e[12]=-(s*m+a*p+o*g),e[13]=-(u*m+h*p+c*g),e[14]=-(d*m+f*p+l*g),e[15]=1)}(this.view,this.position,s,this.up)}get_view(){return this.view}}class v{constructor(){this.triangles=[],this.triangles.push(new f([2,0,0],0)),this.player=new l([-2,0,.5],0,0)}update(){this.triangles.forEach((e=>e.update())),this.player.update()}get_player(){return this.player}get_triangles(){return this.triangles}}const m=document.getElementById("gfx-main"),p=new class{constructor(e){this.run=()=>{this.scene.update(),this.renderer.render(this.scene.get_player(),this.scene.get_triangles()),requestAnimationFrame(this.run)},this.canvas=e,this.renderer=new u(e),this.scene=new v}initialize(){return e=this,t=void 0,r=function*(){yield this.renderer.Initialize()},new((i=void 0)||(i=Promise))((function(n,s){function a(e){try{u(r.next(e))}catch(e){s(e)}}function o(e){try{u(r.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}u((r=r.apply(e,t||[])).next())}));var e,t,i,r}}(m);p.initialize(),p.run()})();